<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>WinJS Contrib Source: winjscontrib.ui.multipass-renderer.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">WinJS Contrib</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#WinJSContrib">WinJSContrib</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Alerts.html">Alerts</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Bindings.html">Bindings</a>
						</li>
						
						<li>
							<a href="WinJSContrib.CrossPlatform.html">CrossPlatform</a>
						</li>
						
						<li>
							<a href="WinJSContrib.CrossPlatform.isMobile.html">isMobile</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.html">Logging</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.Appenders.html">Appenders</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.html">Search</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Stemming.html">Stemming</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Stemming.Op.html">Op</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Stemming.StopWords.html">StopWords</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Templates.html">Templates</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.html">UI</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.Animation.html">Animation</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataForm.Converters.html">Converters</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.html">DataSources</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.Grouping.html">Grouping</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Utils.html">Utils</a>
						</li>
						
						<li>
							<a href="WinJSContrib.WinRT.html">WinRT</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="WinJSContrib.Logging.Appenders.ConsoleAppender.html">ConsoleAppender</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.LoggerClass.html">LoggerClass</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Messenger.html">Messenger</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Messenger.SmartWorker.html">SmartWorker</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Index.html">Index</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.IndexGroup.html">IndexGroup</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.IndexWorkerProxy.html">IndexWorkerProxy</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Stemming.Pipeline.html">Pipeline</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.ChildViewFlyout.html">ChildViewFlyout</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataForm.html">DataForm</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.DataSourceManager.html">DataSourceManager</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.EventTracker.html">EventTracker</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.ExtendedSplash.html">ExtendedSplash</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlipSnap.html">FlipSnap</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlipViewPager.html">FlipViewPager</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FluentDOM.html">FluentDOM</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlyoutPage.html">FlyoutPage</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.GlobalProgress.html">GlobalProgress</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.GridControl.html">GridControl</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.HubControl.html">HubControl</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MediaTrigger.html">MediaTrigger</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MultiPassItem.html">MultiPassItem</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MultiPassRenderer.html">MultiPassRenderer</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.PageControlNavigator.html">PageControlNavigator</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.SemanticListViews.html">SemanticListViews</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.SmartListLayout.html">SmartListLayout</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UPnP.UPnPDevice.html">UPnPDevice</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: winjscontrib.ui.multipass-renderer.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/* 
 * WinJS Contrib v2.1.0.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib = WinJSContrib || {};
WinJSContrib.UI = WinJSContrib.UI || {};

(function () {
	"use strict";

	WinJSContrib.UI.MultiPassRenderer = WinJS.Class.define(
    /**
     * This control manage multi-pass rendering for improving performances when showing a list of items.
     * The renderer will render "shells" for the items to enable page layout, and render items content on demand, or when items scrolls to view.  
     * @class WinJSContrib.UI.MultiPassRenderer
     */
    function (element, options) {
    	options = options || {};
    	this.items = [];
    	this.element = element;
    	this._scrollProcessor = null;
    	this._tolerance = 1;
    	this._virtualize = false;
    	this._scrollContainer = options.scrollContainer || null;
    	this._multipass = options.multipass || false;
    	this._orientation = options.orientation || '';
    	this.itemClassName = options.itemClass || options.className || options.itemClassName;
    	this.itemTemplate = WinJSContrib.Utils.getTemplate(options.template || options.itemTemplate);
    	this.itemInvoked = options.invoked || options.itemInvoked;
    	this.onitemContent = options.onitemContent;
    	this._onScrollBinded = this._onScroll.bind(this);

    	if (element) {
    		element.className = element.className + ' mcn-items-ctrl mcn-layout-ctrl win-disposable';
    	}

    	//element.mcnRenderer = this;
    	//WinJS.UI.setOptions(this, options);
    },
    /**
      * @lends WinJSContrib.UI.MultiPassRenderer.prototype
      */
    {
    	/**
         * kind of multipass, can be 'section', or 'item'
         * @type {String}
         * @field
         */
    	multipass: {
    		get: function () {
    			return this._multipass;
    		},
    		set: function (val) {
    			this._multipass = val;
    			this.refreshScrollEvents();
    		}
    	},

    	/**
         * tolerance for determining if the rendering should apply. Tolerance is expressed in scroll container proportion. For example, 1 means that tolerance is equal to scroll container size
         * @type {number}
         * @field
         */
    	tolerance: {
    		get: function () {
    			return this._tolerance;
    		},
    		set: function (val) {
    			this._tolerance = val;
    		}
    	},

    	/**
         * indicate if renderer empty items out of sight
         * @type {boolean}
         * @field
         */
    	virtualize: {
    		get: function () {
    			return this._virtualize;
    		},
    		set: function (val) {
    			this._virtualize = val;
    		}
    	},

    	/**
         * could be 'vertical' or 'horizontal'
         * @type {String}
         * @field
         */
    	orientation: {
    		get: function () {
    			return this._orientation;
    		},
    		set: function (val) {
    			this._orientation = val;
    			this.refreshScrollEvents();
    		}
    	},

    	/**
         * Element containing scroll. If scrollContainer is filled, items content will get rendered when coming into view
         * @type {HTMLElement}
         * @field
         */
    	scrollContainer: {
    		get: function () {
    			return this._scrollContainer;
    		},
    		set: function (val) {
    			this._unregisterScrollEvents();
    			this._scrollContainer = val;
    			this._registerScrollEvents();
    			//this.checkRendering();
    		}
    	},

    	_onScroll: function () {
    		var ctrl = this;
    		if (ctrl.scrollContainer &amp;&amp; ctrl._scrollProcessor) {
    			if (ctrl._scrollRequest) {
    				cancelAnimationFrame(ctrl._scrollRequest);
    			}

    			ctrl._scrollRequest = requestAnimationFrame(function () {
    				ctrl.checkRendering();
    			});
    		}
    	},

    	_unregisterScrollEvents: function () {
    		this._scrollProcessor = null;
    		this.clearOffsets();
    		if (this.scrollContainer) {
    			this.scrollContainer.removeEventListener('scroll', this._onScrollBinded);
    		}
    	},

    	_registerScrollEvents: function () {
    		var ctrl = this;
    		if (ctrl.scrollContainer) {
    			this.scrollContainer.addEventListener('scroll', this._onScrollBinded);

    			if (ctrl.orientation == 'vertical') {
    				if (ctrl.multipass == 'section') {
    					ctrl._scrollProcessor = function () { ctrl._checkSection(ctrl._vIsInView); }
    				} else if (ctrl.multipass == 'item') {
    					ctrl._scrollProcessor = function () { ctrl._checkItem(ctrl._vIsInView); }
    				}
    			} else {
    				if (ctrl.multipass == 'section') {
    					ctrl._scrollProcessor = function () { ctrl._checkSection(ctrl._hIsInView); }
    				} else if (ctrl.multipass == 'item') {
    					ctrl._scrollProcessor = function () { ctrl._checkItem(ctrl._hIsInView); }
    				}
    			}
    		}
    	},

    	/**
         * refresh scroll events associated to multi pass renderer
         */
    	refreshScrollEvents: function () {
    		this._unregisterScrollEvents();
    		this._registerScrollEvents();
    		this.clearOffsets();
    	},

    	_vIsInView: function (rect, scrollContainer, tolerance) {
    		var pxTolerance = scrollContainer.clientHeight * tolerance;
    		if (rect.y >= scrollContainer.scrollTop - pxTolerance &amp;&amp; rect.y &lt;= scrollContainer.scrollTop + scrollContainer.clientHeight + pxTolerance)
    			return true;

    		if (rect.y + rect.height >= scrollContainer.scrollTop - pxTolerance &amp;&amp; rect.y + rect.height &lt;= scrollContainer.scrollTop + scrollContainer.clientHeight + pxTolerance)
    			return true;

    		if (rect.y &lt;= scrollContainer.scrollTop - pxTolerance &amp;&amp; rect.y + rect.height >= scrollContainer.scrollTop + scrollContainer.clientHeight + pxTolerance)
    			return true;

    		return false;
    	},

    	_hIsInView: function (rect, scrollContainer, tolerance) {
    		var pxTolerance = scrollContainer.clientWidth * (tolerance || 0);
    		if (rect.x >= scrollContainer.scrollLeft - pxTolerance &amp;&amp; rect.x &lt;= scrollContainer.scrollLeft + scrollContainer.clientWidth + pxTolerance)
    			return true;

    		if (rect.x + rect.width >= scrollContainer.scrollLeft - pxTolerance &amp;&amp; rect.x + rect.width &lt;= scrollContainer.scrollLeft + scrollContainer.clientWidth + pxTolerance)
    			return true;

    		if (rect.x &lt;= scrollContainer.scrollLeft - pxTolerance &amp;&amp; rect.x + rect.width >= scrollContainer.scrollLeft + scrollContainer.clientWidth + pxTolerance)
    			return true;

    		return false;
    	},

    	/**
         * Clear cached offsets for bloc and for items
         */
    	clearOffsets: function () {
    		var ctrl = this;
    		ctrl.rect = null;
    		ctrl.items.forEach(function (item) {
    			item.rect = null;
    		});
    	},

    	/**
         * update ui related properties like cached offsets, scroll events, ...
         */
    	updateLayout: function () {
    		var ctrl = this;
    		ctrl.refreshScrollEvents();
    	},

    	_checkSection: function (check, tolerance, noRender) {
    		var ctrl = this;
    		tolerance = tolerance || 0;

    		if (!ctrl.rect &amp;&amp; ctrl.items &amp;&amp; ctrl.items.length) {
    			ctrl.rect = WinJSContrib.UI.offsetFrom(ctrl.element, ctrl.scrollContainer);
    		} else {
    			ctrl.rect = ctrl.rect || { x: 0, y: 0, width: 0, height: 0 };
    			ctrl.rect.width = ctrl.element.clientWidth;
    			ctrl.rect.height = ctrl.element.clientHeight;
    		}

    		if (check(ctrl.rect, ctrl.scrollContainer, tolerance)) {
    			if (noRender)
    				return true;

    			ctrl.renderItemsContent();
    			if (ctrl.onrendersection) {
    				ctrl.onrendersection();
    			}
    		} else if (ctrl.virtualize &amp;&amp; tolerance > 0 &amp;&amp; ctrl.items &amp;&amp; ctrl.items.length &amp;&amp; ctrl.items[0].rendered) {
    			ctrl.items.forEach(function (item) {
    				item.empty();
    			});
    		}

    		if (tolerance == 0 &amp;&amp; ctrl.tolerance > 0) {
    			setImmediate(function () {
    				ctrl._checkSection(check, ctrl.tolerance);
    			});
    		}
    	},

    	_checkItem: function (check, tolerance) {
    		var ctrl = this;
    		tolerance = tolerance || 0;
    		var allRendered = true;

    		var countR = function () {
    			var countRendered = 0;
    			ctrl.items.forEach(function (item) {
    				if (item.rendered) {
    					countRendered++;
    				}
    			});
    			console.log('rendered ' + countRendered);
    		}

    		if (ctrl._checkSection(check, tolerance, true)) {
    			ctrl.items.forEach(function (item) {
    				if (!item.rect) {
    					item.rect = WinJSContrib.UI.offsetFrom(item.element, ctrl.scrollContainer);
    				}
    				allRendered = allRendered &amp; item.rendered;

    				if (!item.rendered &amp;&amp; check(item.rect, ctrl.scrollContainer, tolerance)) {
    					item.render();
    				} else if (item.rendered &amp;&amp; ctrl.virtualize &amp;&amp; tolerance > 0 &amp;&amp; !check(item.rect, ctrl.scrollContainer, tolerance)) {
    					item.empty();
    				}
    			});
    			ctrl.allRendered = allRendered;
    			//countR();
    		} else if (tolerance > 0 &amp;&amp; ctrl.items.length &amp;&amp; (ctrl.items[0].rendered || ctrl.items[ctrl.items.length - 1].rendered)) {
    			ctrl.items.forEach(function (item) {
    				if (!item.rect) {
    					item.rect = WinJSContrib.UI.offsetFrom(item.element, ctrl.scrollContainer);
    				}
    				if (ctrl.virtualize &amp;&amp; !check(item.rect, ctrl.scrollContainer, tolerance)) {
    					item.empty();
    				}
    			});
    			//countR();
    		}

    		if (tolerance == 0 &amp;&amp; ctrl.tolerance > 0) {
    			setImmediate(function () {
    				ctrl._checkItem(check, ctrl.tolerance);
    			});
    		}


    	},

    	/**
         * render items shells to the page
         * @param {Array} items array of items to render
         * @param {Object} renderOptions options for rendering items, can override control options like item template
         */
    	prepareItems: function (items, renderOptions) {
    		var ctrl = this;
    		items = items || [];
    		renderOptions = renderOptions || {};
    		var numItems = items.length;

    		var itemInvoked = renderOptions.itemInvoked || ctrl.itemInvoked;
    		if (typeof itemInvoked == 'string')
    			itemInvoked = WinJSContrib.Utils.resolveMethod(ctrl.element, itemInvoked);
    		var template = WinJSContrib.Utils.getTemplate(renderOptions.template) || ctrl.itemTemplate;
    		var className = renderOptions.itemClassName || ctrl.itemClassName;
    		var onitemInit = renderOptions.onitemInit || ctrl.onitemInit;
    		var onitemContent = renderOptions.onitemContent || ctrl.onitemContent;
    		var container = ctrl.element;
    		var registereditems = ctrl.items;

    		items.forEach(function (itemdata) {
    			var item = new WinJSContrib.UI.MultiPassItem(ctrl, null, {
    				data: itemdata,
    				template: template,
    				className: className,
    				itemInvoked: itemInvoked,
    				onitemInit: onitemInit,
    				onitemContent: onitemContent
    			});
    			registereditems.push(item);
    			container.appendChild(item.element);
    		});
    		//for (var i = 0 ; i &lt; numItems; i++) {
    		//    var itemdata = items[i];
    		//    var item = new WinJSContrib.UI.MultiPassItem(ctrl, null, {
    		//        data: itemdata,
    		//        template: template,
    		//        className: className,
    		//        itemInvoked: itemInvoked,
    		//        onitemInit: onitemInit,
    		//        onitemContent: onitemContent
    		//    });
    		//    registereditems.push(item);
    		//    container.appendChild(item.element);
    		//}

    		if (renderOptions.renderItems || !this.multipass) {
    			ctrl.renderItemsContent();
    		}
    		//ctrl.element.style.display = '';
    	},

    	/**
         * check rendering of items, based on multipass configuration (force items on screen to render)
         */
    	checkRendering: function () {
    		var ctrl = this;
    		if (ctrl._scrollProcessor)
    			ctrl._scrollProcessor();
    	},

    	/**
         * force rendering of all unrendered items
         */
    	renderItemsContent: function () {
    		var ctrl = this;
    		ctrl.items.forEach(function (item) {
    			if (!item.rendered) {
    				//setImmediate(function () {
    				item.render();
    				//});
    			}
    		});
    		ctrl.allRendered = true;
    	},

    	/**
         * release resources for multipass renderer
         */
    	dispose: function () {
    		var ctrl = this;
    		ctrl._unregisterScrollEvents();
    		WinJSContrib.UI.untapAll(ctrl.element);
    		WinJS.Utilities.disposeSubTree(ctrl.element);
    	}
    });

	WinJSContrib.UI.MultiPassItem = WinJS.Class.define(
        /**
         * Item for multipass rendering
         * @class WinJSContrib.UI.MultiPassItem
         */
    function (renderer, element, options) {
    	options = options || {};
    	var item = this;
    	item.renderer = renderer;
    	item.element = element || document.createElement('DIV');
    	item.element.className = item.element.className + ' ' + options.className + ' mcn-multipass-item unloaded';
    	item.element.winControl = item;

    	item.itemInvoked = options.itemInvoked;
    	item.itemDataPromise = WinJS.Promise.as(options.data);

    	item.itemTemplate = options.template;
    	item.rendered = false;
    	item.onitemContent = options.onitemContent;
    	if (options.onitemInit) {
    		options.onitemInit(this);
    	}
    },
    /**
     * @lends WinJSContrib.UI.MultiPassItem
     */
    {
    	/**
         * render item content
         */
    	render: function (delayed) {
    		var ctrl = this;

    		if (ctrl.itemTemplate &amp;&amp; !ctrl.rendered) {

    			ctrl.rendered = true;
    			return ctrl._renderContent();
    		}

    		return WinJS.Promise.wrap(ctrl.contentElement);
    	},

    	/**
         * empty item and mark it as unrendered
         */
    	empty: function () {
    		var ctrl = this;
    		if (ctrl.rendered) {
    			WinJSContrib.UI.untapAll(ctrl.element);
    			ctrl.element.classList.remove('loaded');
    			ctrl.element.innerHTML = '';
    			ctrl.rendered = false;
    		}
    	},

    	_renderContent: function () {
    		var ctrl = this;

    		if (ctrl.itemTemplate) {
    			return ctrl.itemDataPromise.then(function (data) {
    				ctrl.itemData = data;
    				return ctrl.itemTemplate.render(data).then(function (rendered) {
    					ctrl.element.appendChild(rendered);

    					if (ctrl.itemInvoked) {
    						if (typeof ctrl.itemInvoked == 'string')
    							ctrl.itemInvoked = WinJSContrib.Utils.resolveMethod(ctrl.element, ctrl.itemInvoked);

    						if (ctrl.itemInvoked) {
    							WinJSContrib.UI.tap(ctrl.element, function (arg) {
    								ctrl.itemInvoked(ctrl);
    							});
    						}
    					}

    					if (ctrl.onitemContent) {
    						ctrl.onitemContent(ctrl.itemData, rendered);
    					}
    					else if (ctrl.renderer.onitemContent) {
    						ctrl.renderer.onitemContent(ctrl.itemData, rendered);
    					}

    					setImmediate(function () {
    						ctrl.element.classList.remove('unloaded');
    						ctrl.element.classList.add('loaded');
    					});

    					ctrl.rendered = true;
    					ctrl.contentElement = rendered;
    					return rendered;
    				});
    			});
    		}

    		return WinJS.Promise.wrap();
    	}
    });
})();</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					by MCNEXT
					<br />
					
					
		<span class="copyright">
		copyright MCNEXT
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Wed Apr 22 2015 22:33:30 GMT+0200 (Romance Daylight Time) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
